# 收银系统（中西文）设计方案

## 目标
构建一套支持中英文界面的收银系统，覆盖电脑端（POS/后台）与手机端（移动收银/管理）并保证数据实时同步。系统需具备离线容错、库存管理、会员营销和报表分析等核心能力。

## 总体架构
- **客户端**：
  - 响应式 Web（PWA）+ 桌面端（Electron 打包）满足柜台/后台使用。
  - 移动端使用同一 Web 代码基通过 PWA 安装，或提供 Capacitor 打包以便访问硬件（打印、扫码、NFC）。
- **网关/同步层**：
  - GraphQL/REST API 提供统一数据访问；WebSocket/Server-Sent Events 用于订单与库存的实时推送。
  - 离线队列（IndexedDB/SQLite）缓存未同步的订单与库存调整，网络恢复后自动重放。
- **服务端**：
  - 应用服务（Node.js/TypeScript 或 NestJS）处理业务逻辑。
  - 事件流（Kafka/Redis Stream）分发库存与结算事件，保障多终端一致性。
  - 数据存储：PostgreSQL（事务数据）、Redis（会话/缓存）、对象存储（电子小票与图片）。
- **设备支持**：
  - ESC/POS 打印、USB/蓝牙扫码枪、现金抽屉、称重设备（HID/串口）。

## 关键功能
- **收银开单**：扫码/手输商品、折扣与促销、挂单/并单、退换货，支持中文/英文界面切换。
- **库存管理**：实时库存扣减、盘点、移库、采购入库。终端间通过事件流与 WebSocket 同步。
- **会员与营销**：积分、优惠券、储值卡；支持手机端自助核销。
- **支付与结算**：现金、银行卡、微信/支付宝、Apple Pay/Google Pay；支持对账与结班。
- **报表与监控**：销售日报、畅销/滞销排行、毛利分析；Web 端仪表盘实时刷新。

## 数据同步与一致性
- **实时通道**：订单、库存、支付状态等关键事件经事件流广播，再由 WebSocket 推送至已订阅的终端。
- **离线策略**：客户端将操作写入本地队列（含重试与幂等键），网络恢复后按时间戳顺序重放；服务器使用乐观锁/版本号防重。
- **冲突处理**：
  - 库存盘点/调拨采用版本号校验，失败时返回最新数据提示用户选择覆盖或合并。
  - 订单支付状态以支付网关回调为准，客户端显示同步状态并允许重新查询。

## 多语言与国际化
- 前端使用 i18n（如 i18next/Intl）管理文案，JSON 词条文件支持热更新。
- 文本/货币/日期采用 locale 自动格式化；打印模板区分中英文本。
- 后台管理支持多语言操作员账号与权限配置。

## 安全与合规
- OAuth 2.1 / OpenID Connect 进行员工登录与权限控制。
- 所有接口强制 HTTPS；敏感数据加密存储，支付信息符合各支付通道合规要求。
- 审计日志记录价格变动、退款、库存调整等关键操作。

## 部署与运维
- 微服务/单体均可：初期可单体 + 模块化，后期按领域拆分（结算、库存、会员）。
- CI/CD：单元测试、端到端测试、Lint 与国际化词条检查；自动生成部署包（Web/PWA/Electron/移动）。
- 监控：Prometheus + Grafana；日志集中化（ELK/ClickHouse），报警覆盖支付失败率和同步延迟。

## 里程碑建议
1. **MVP（2-4 周）**：商品/库存/开单、微信/支付宝支付、基础报表、双语界面、PWA。
2. **同步增强（1-2 周）**：事件流 + WebSocket 推送、离线队列与重放、Electron/移动打包。
3. **扩展阶段（持续）**：会员营销、第三方硬件适配、更多支付方式、数据仓库与 BI。
